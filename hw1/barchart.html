<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
  <style type="text/css">
    rect {
        fill:steelblue;
        fill-opacity:.8;
    }
    .axis path, 
    .axis line {
        fill: none;
        stroke: #000;
    }
    .axis text{
        font: 12px sans-serif;
    }
    #time_slider{
        width: 400px;
    }
    .slider{
        display: inline-block;
    }
    p{
        display: inline;
    }
  </style>
</head>
<body>
    <!-- Update by year -->
    <div class = "slider">
    Time Update:
    <p id="min_year"></p><input type="range" id="time_slider" name="points" min="1995" max="2012" value="0" step="1" oninput="update_year(this.value)"></input><p id = "max_year"></p>
    </div>
    <br>
    <!-- Pick a data type -->
    Pick Data:
    <label>Population<input class = "pick_data" type="radio" id="pick_population" name="pick" value="population" onclick="pick_data(this.value)" checked="checked"></input></label> 
    <label>GDP<input class = "pick_data" type="radio" id="pick_gdp" name="pick" value="gdp" onclick="pick_data(this.value)"</input></label> 
    <label>Life Expectancy<input class = "pick_data" type="radio" id="pick_life_expectancy" name="pick" value="life_expectancy" onclick="pick_data(this.value)"></input></label> 

    <!-- Filter by continent -->
    <form action ="">
        Filter by: 
        <label>Americas<input class = "filter_button" type="checkbox" name="filter_continents" value="Americas" id="Americas" title="Americas" onchange="handle_checks()"></input></label>
        <label>Africa<input class = "filter_button" type="checkbox" name="filter_continents" value="Africa" id="Africa" title="Africa" onchange="handle_checks()"></input></label>
        <label>Asia<input class = "filter_button" type="checkbox" name="filter_continents" value="Asia" id="Asia" title="Asia" onchange="handle_checks()"></input></label>
        <label>Europe<input class = "filter_button" type="checkbox" name="filter_continents" value="Europe" id="Europe" title="Europe" onchange="handle_checks()"></input></label>
        <label>Oceania<input class = "filter_button" type="checkbox" name="filter_continents" value="Oceania" id="Oceania" title="Oceania" onchange="handle_checks()"></input></label>
    </form>

    <!-- Filter by Aggregation -->
    Aggregation:
    <label>None<input type="radio" id = "none" name="aggregation" value="none" onclick="none()" checked="checked"></input></label>
    <label>By Continent<input type="radio" id = "bycontinent" name="aggregation" value="bycontinent" onclick="aggregate()"></input></label>
     <br>

    <!-- Sort function -->
    Sort by:
    <label>Name<input class = "sort" type="radio" id = "sort_name" name="sort_by" value="name" onclick="sort_data(this.value)" checked="checked"></input></label>
    <label>Population<input class = "sort" type="radio" id = "sort_population" name="sort_by" value="population" onclick="sort_data(this.value)"></input></label>
    <label>GDP<input class = "sort" type="radio" id = "sort_gdp" name="sort_by" value="gdp" onclick="sort_data(this.value)"></input></label>
    <label>Life Expectancy<input class = "sort" type="radio" id = "sort_life_expectancy" name="sort_by" value="life_expectancy" onclick="sort_data(this.value)"></input></label>
    <br>
    <br>

  <script type="text/javascript">
    var original_data = []
    var filtered_data = []
    var categories = ["name", "continent", "gdp", "life_expectancy", "population", "year"];
    var continents = {"Americas": true, "Africa":true, "Asia":true, "Europe":true, "Oceania": true};
    var current_year = 1995
    var margin = {top: 50, bottom: 10, left:200, right: 40};
    var encoding = "population";
    var sorting = "name";

    var flatten_data = function(given_year){
        var flat_data = []
        for (var i=0; i < original_data.length; i++){
            flat_data[i] = {name: original_data[i].name, continent: original_data[i].continent, gdp:original_data[i].years[given_year-1995].gdp, life_expectancy: original_data[i].years[given_year-1995].life_expectancy, population: original_data[i].years[given_year-1995].population, year: original_data[i].years[given_year-1995].year};
        }
        return flat_data;
    };

    var pick_data = function(new_encoding){
        encoding = new_encoding
        d3.selectAll(".pick_data").property("checked", false)
        d3.select("#pick_"+encoding).property("checked", true)
        update_bar(encoding)
    }

    var sort_data = function(new_sorting){
        sorting = new_sorting;
        d3.selectAll(".sort").property("checked", false)
        d3.select("#sort_"+sorting).property("checked", true)
        filtered_data = filtered_data.sort(function(a, b){
            if (sorting == "name"){
                return d3.ascending(a[sorting], b[sorting]);
            }
            else {
                if (a[sorting] == b[sorting]){
                    return d3.ascending(a["name"], b["name"]);
                }
                return d3.descending(a[sorting], b[sorting]);
            }
        })
        update_bar(encoding)
    }

    var update_year = function(new_year){
        current_year = new_year
        if (d3.select("#none").property("checked") == true){
            filtered_data = flatten_data(new_year);
            handle_checks()
        }
        else{
            aggregate()
            }
    }

    var min_max_year = function(){
        min_year = d3.select("#time_slider").attr("min")
        max_year = d3.select("#time_slider").attr("max")
        d3.select("#min_year").text(min_year)
        d3.select("#max_year").text(max_year)
    }

    var none = function(){
        d3.select("#bycontinent").property("checked", false)
        filtered_data = flatten_data(current_year)
        handle_checks()
    }

    var aggregate = function(){
        d3.select("#none").property("checked", false)
        filtered_data = flatten_data(current_year)
        detect_checks()
        update_filter()
        var nested_rows = d3.nest()
            .key(function(d){
                return d.continent;
            })
            .rollup(function(d){
                return {
                    gdp: d3.sum(d, function(g){
                        return +g.gdp;
                    }),
                    life_expectancy: d3.mean(d, function(g){
                        return +g.life_expectancy;
                    }),             
                    population: d3.sum(d, function(g){
                        return +g.population;
                    }),
                    year: d3.median(d, function(g){
                        return g.year
                    })
                };
            })
            .entries(filtered_data)

            filtered_data = nested_rows.map(function(d){
                return {name: d.key, continent: d.key, gdp: d.values.gdp, life_expectancy: d.values.life_expectancy, population: d.values.population, year: d.values.year};
            })
            sort_data(sorting)
            update_bar(encoding)
}

    var detect_checks = function(){
        var counter = 0;

        for (var key in continents){
            continents[key] = false;
        }
        d3.selectAll(".filter_button").each(function(d){
            if(d3.select(this).attr("type")=="checkbox" && d3.select(this).node().checked){
                var cont_name = d3.select(this).property("value");
                continents[cont_name] = true;
            }
            else{
                counter++
            }
        })

        if (counter == Object.keys(continents).length){
            for (var key in continents){
                continents[key] = true
            }
            filtered_data = flatten_data(current_year)
        }   
    }

    var handle_checks = function(){
        detect_checks()
        if (d3.select("#none").property("checked") == true){
            filtered_data = flatten_data(current_year)
            update_filter()
        }
        else{
            aggregate()
        }
    }

    var update_filter = function(){
        filtered_data = filtered_data.filter(function(d){
            return continents[d.continent]
        });
        if (d3.select("#none").property("checked") == true){
            sort_data(sorting)
            update_bar(encoding)
        }
    }

    var aggregate_scale = function(temp_data){
        var nested_rows = d3.nest()
            .key(function(d){
                return d.continent;
            })
            .rollup(function(d){
                return {
                    gdp: d3.sum(d, function(g){
                        return +g.gdp;
                    }),
                    life_expectancy: d3.mean(d, function(g){
                        return +g.life_expectancy;
                    }),             
                    population: d3.sum(d, function(g){
                        return +g.population;
                    }),
                    year: d3.median(d, function(g){
                        return g.year
                    })
                };
            })
            .entries(temp_data)

            temp_data = nested_rows.map(function(d){
                return {name: d.key, continent: d.key, gdp: d.values.gdp, life_expectancy: d.values.life_expectancy, population: d.values.population, year: d.values.year};
            })
        return temp_data
    }
    var find_max = function(){
        var max = 0;
        var new_max = 0;
        var temp_data = [];
        if (d3.select("#bycontinent").property("checked") == true){
            console.log("1");
            if (encoding == "population"){
                for (var year = 1995; year <= 2012; year++){
                    temp_data = flatten_data(year)
                    temp_data = aggregate_scale(temp_data)
                    new_max = d3.max(temp_data, function(d){ return d.population})
                    if (new_max >= max){
                        max = new_max;
                    }
                }
            }
            else if (encoding == "gdp"){
                for (var year = 1995; year <= 2012; year++){
                    temp_data = flatten_data(year)
                    temp_data = aggregate_scale(temp_data)
                    new_max = d3.max(temp_data, function(d){ return d.gdp})
                    if (new_max >= max){
                        max = new_max;
                    }
                }   
            }
            else if (encoding == "life_expectancy"){
                for (var year = 1995; year <= 2012; year++){
                    temp_data = flatten_data(year)
                    temp_data = aggregate_scale(temp_data)
                    new_max = d3.max(temp_data, function(d){ return d.life_expectancy})
                    if (new_max >= max){
                        max = new_max;
                    }
                }   
            }   

        } 
        else {
            if (encoding == "population"){
                for (var year = 1995; year <= 2012; year++){
                    temp_data = flatten_data(year)
                    new_max = d3.max(temp_data, function(d){ return d.population})
                    if (new_max >= max){
                        max = new_max;
                    }
                }
            }
            else if (encoding == "gdp"){
                for (var year = 1995; year <= 2012; year++){
                    temp_data = flatten_data(year)
                    new_max = d3.max(temp_data, function(d){ return d.gdp})
                    if (new_max >= max){
                        max = new_max;
                    }
                }   
            }
            else if (encoding == "life_expectancy"){
                for (var year = 1995; year <= 2012; year++){
                    temp_data = flatten_data(year)
                    new_max = d3.max(temp_data, function(d){ return d.life_expectancy})
                    if (new_max >= max){
                        max = new_max;
                    }
                }   
            }
        }
        return max
    }

    var update_bar = function(encoding){
        var width = 1000 - margin.left - margin.right;
        var height = filtered_data.length * 25 - margin.top - margin.bottom;
        if (height < 25){
            height = 25;
        }
        var xScale = d3.scale.linear().range([0, width]);
        var yScale = d3.scale.ordinal().rangeRoundBands([0, height], .8, 0);

        d3.select("svg").remove();

        var svg = d3.select("body").append("svg")
                    .attr("width", width+margin.left+margin.right)
                    .attr("height", height+margin.top+margin.bottom);
     

        var g = svg.append("g")
                    .attr("transform", "translate("+margin.left+","+margin.top+")")
        
        // var max;
        // if (encoding == "population"){
        //     max = d3.max(filtered_data, function(d) { return d.population} );
        // }
        // else if (encoding == "gdp"){
        //     max = d3.max(filtered_data, function(d) { return d.gdp} );
        // }
        // else if (encoding == "life_expectancy"){
        //     max = d3.max(filtered_data, function(d) { return d.life_expectancy} );
        // }
        
        var max = find_max()

        var min = 0;


        //yAxis is the vertial axis 
        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient("left");  
        xScale.domain([min, max]);
        yScale.domain(filtered_data.map(function(d) { return d.name; }));
    
        g.append("g")
            .attr("class", "y axis")
            .call(yAxis)

        var rows = g.append("g")
                    .selectAll("g.row")
                    .data(filtered_data)
                  .enter()
                    .append("g")
                    .attr("class", "row")
                    .text(function(d){return d.name})
 
        var bars = rows
                    .append("rect")
                    //.attr("width", function(d) { return xScale(filtered_data); })
                    .attr("height", 5)
                    .attr("x", xScale(min))
                    .attr("y", function(d) { return yScale(d.name); })

        if (encoding == "population"){
            bars.attr("width", function(d){ return xScale(d.population)})
        }
        else if (encoding == "gdp"){
            bars.attr("width", function(d){ return xScale(d.gdp)})
        }
        else if (encoding == "life_expectancy"){
            bars.attr("width", function(d){ return xScale(d.life_expectancy)})
        }
    }
    d3.json("data/countries_1995_2012.json", function(error, data) {
        original_data = data;
        filtered_data = flatten_data(current_year)
        sort_data(sorting);
        update_bar(encoding);
        min_max_year()
    });
  </script>
</body>
</html>